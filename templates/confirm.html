<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>【確認・修正】リハビリテーション実施計画書</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <script>mermaid.initialize({ startOnLoad: false });</script>
    <style>
        .mermaid svg {
            max-width: 100%;
            height: auto;
        }
    </style>
    <style>
        .patient-info {
            background-color: var(--secondary-color);
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            border-left: 5px solid var(--primary-color);
            line-height: 1.8;
        }

        .generation-status-icon {
            width: 24px;
            margin-right: 8px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            vertical-align: middle;
        }

        .ai-label::after {
            content: 'AIによる提案 (編集可)';
            font-size: 12px;
            font-weight: normal;
            background-color: #e9ecef;
            color: #495057;
            padding: 3px 8px;
            border-radius: 10px;
            margin-left: 10px;
        }

        .section-title {
            font-size: 1.2em;
            color: var(--primary-color);
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 5px;
            margin-top: 30px;
            margin-bottom: 20px;
        }

        /* 入力欄 */
        .form-control.is-default {
            border-color: orange;
            border-width: 2px;
            background-color: #fff;
        }

        .form-control.is-edited {
            background-color: #f0f4c3;
            border-color: #cddc39;
            border-width: 1px;
        }


        /* 編集ボタン */
        .fixed-buttons {
            position: fixed;
            z-index: 1000;
            display: flex;
            gap: 10px;
        }

        .fixed-buttons {
            bottom: 0;
            left: 0;
            right: 0;

            flex-direction: row;
            justify-content: space-evenly;
            background-color: #f8f9fa;
            padding: 10px;
            border-top: 1px solid #dee2e6;
            box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.1);
        }

        .fixed-buttons hr {
            display: none;
        }

        .fixed-buttons button {
            flex-grow: 1;
            padding: 10px 5px;
        }

        .container {
            padding-bottom: 70px;
        }

        /* 提案比較UI */
        .suggestion-container {
            margin-top: 10px;
        }

        .suggestion-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: .3rem .75rem;
            background-color: #e9ecef;
            border: 1px solid #dee2e6;
            border-bottom: none;
            border-radius: .25rem .25rem 0 0;
        }

        .suggestion-header .model-name {
            font-weight: bold;
            color: var(--primary-color);
        }

        .suggestion-body-wrapper {
            position: relative;
        }

        .suggestion-content {
            display: none;
        }

        .suggestion-content.active {
            display: block;
        }

        .suggestion-text {
            padding: 1rem;
            white-space: pre-wrap;
            /* 改行を維持 */
            min-height: 100px;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
        }

        /* いいねボタン */
        .like-btn {
            color: #6c757d;
            transition: color 0.2s;
        }

        .like-btn.liked,
        .like-btn:hover {
            color: #0d6efd;
            /* Bootstrap Primary Color */
        }

        .suggestion-footer {
            padding: .5rem 1rem;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-top: none;
        }

        summary {
            cursor: pointer;
            outline: none;
            padding: 10px;
            border-radius: 5px;
            transition: background-color 0.2s;
            font-size: 1.2em;
            color: var(--primary-color);
            border-bottom: 2px solid var(--border-color);
            margin-top: 30px;
            margin-bottom: 15px;
            list-style: revert;
            /* 三角マークを表示 */
        }

        summary:hover {
            background-color: #f0f8ff;
            /* ホバー時に薄い青色にする */
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <h1>【確認・修正】リハビリテーション実施計画書</h1>
            <div id="generation-header-status" class="alert alert-info" {% if not is_generating %}style="display: none;"
                {% endif %}>
                <div class="d-flex align-items-center">
                    <div class="spinner-border spinner-border-sm me-2" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <span>AIが計画書を生成中です。完了した項目から編集できます...</span>
                </div>
            </div>
            <p id="generation-finished-text" style="display: none;">AIによる生成が完了しました。内容を確認・修正し、「この内容で確定して保存」ボタンを押してください。
            </p>
        </header>

        <div class="patient-info">
            <strong>対象患者:</strong> {{ patient_data.name }} 様 ({{ patient_data.age }}歳 {{ patient_data.gender }})<br>
            <strong>算定病名:</strong> {{ general_plan.header_disease_name_txt }}
        </div>

        {% macro render_suggestion_switcher(target_id, general_text, specialized_text) %}
        <div class="suggestion-container" data-target-id="{{ target_id }}">
            <div class="suggestion-header">
                <button type="button" class="btn btn-sm btn-outline-secondary suggestion-switch-btn"
                    data-direction="prev">&lt;</button>
                <span class="model-name">通常モデル</span>
                <button type="button" class="btn btn-sm btn-outline-secondary suggestion-switch-btn"
                    data-direction="next">&gt;</button>
            </div>
            <div class="suggestion-body-wrapper">
                {# 通常モデルの提案 (初期表示) #}
                <div class="suggestion-content active" data-model-index="0" data-model-type="general">
                    <div class="suggestion-text" id="suggestion-general-{{ target_id }}" style="white-space: pre-wrap;">
                        {{ general_text or '生成中...' }}
                    </div>
                    <div class="suggestion-footer d-flex justify-content-between align-items-center">
                        <button type="button" class="btn btn-sm btn-outline-secondary regenerate-btn" data-bs-toggle="modal" data-bs-target="#regenerateModal">
                            <i class="bi bi-arrow-repeat"></i> 再生成
                        </button>
                        <div>
                            <button type="button" class="btn like-btn me-2" title="この提案を評価">
                                <i class="bi bi-hand-thumbs-up"></i>
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-primary apply-suggestion-btn">
                                この提案を適用
                            </button>
                        </div>
                    </div>
                </div>
                {# 特化モデルの提案 (初期非表示) #}
                <div class="suggestion-content" data-model-index="1" data-model-type="specialized">
                    <div class="suggestion-text" id="suggestion-specialized-{{ target_id }}" style="white-space: pre-wrap;">
                        {{ specialized_text or '生成中...' }}
                    </div>
                    <div class="suggestion-footer d-flex justify-content-between align-items-center">
                        <button type="button" class="btn btn-sm btn-outline-secondary regenerate-btn" data-bs-toggle="modal" data-bs-target="#regenerateModal">
                            <i class="bi bi-arrow-repeat"></i> 再生成
                        </button>
                        <div>
                            <button type="button" class="btn like-btn me-2" title="この提案を評価">
                                <i class="bi bi-hand-thumbs-up"></i>
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-primary apply-suggestion-btn">
                                この提案を適用
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endmacro %}

        <form id="confirm-form" action="{{ url_for('save_plan') }}" method="post">
            {# plan_id は新しいレコードとして登録するので、フォームに含めないようにする #}
            <input type="hidden" name="patient_id" value="{{ patient_data.patient_id }}">
            <input type="hidden" name="plan_id" value="">

            {% set editable_keys = ['main_risks_txt', 'main_contraindications_txt',
            'func_pain_txt', 'func_rom_limitation_txt', 'func_muscle_weakness_txt',
            'func_swallowing_disorder_txt', 'func_behavioral_psychiatric_disorder_txt',
            'cs_motor_details',
            'func_nutritional_disorder_txt', 'func_excretory_disorder_txt', 'func_pressure_ulcer_txt',
            'func_contracture_deformity_txt', 'func_motor_muscle_tone_abnormality_txt',
            'func_disorientation_txt', 'func_memory_disorder_txt',
            'adl_equipment_and_assistance_details_txt', 'goals_1_month_txt', 'goals_at_discharge_txt',
            'policy_treatment_txt', 'policy_content_txt', 'goal_p_action_plan_txt', 'goal_a_action_plan_txt',
            'goal_s_psychological_action_plan_txt', 'goal_s_env_action_plan_txt', 'goal_s_3rd_party_action_plan_txt'
            ] %}

            <input type="hidden" name="therapist_notes" value="{{ therapist_notes }}">

            {% for key, value in general_plan.items() %}
            {% if key not in editable_keys and key != 'plan_id' and value is not none %}
            <input type="hidden" name="{{ key }}" value="{{ value }}">
            {% endif %}
            {% endfor %}
            {# 【追加】AI提案テキストを送信するための隠しフィールド #}
            {% for key in editable_keys %}
            <input type="hidden" name="suggestion_general_{{ key }}" id="hidden-suggestion-general-{{ key }}"
                value="{{ general_plan[key] }}">
            <input type="hidden" name="suggestion_specialized_{{ key }}" id="hidden-suggestion-specialized-{{ key }}"
                value="{{ specialized_plan[key] }}">
            {% endfor %}
            
            <!-- 【追加】再生成履歴を送信するための隠しフィールド -->
            <input type="hidden" name="regeneration_history" id="regeneration-history-input">


            <h2 class="section-title">【1枚目】所見・方針</h2>

            <div class="form-group">
                <label for="main_risks_txt" class="ai-label d-flex align-items-center"><span
                        class="generation-status-icon" id="icon-main_risks_txt">
                        <div class="spinner-border spinner-border-sm text-secondary" role="status"></div>
                    </span>安静度・リスク</label>
                <textarea name="main_risks_txt" id="main_risks_txt" class="form-control" readonly
                    placeholder="AIが生成中です...">{{ general_plan.main_risks_txt }}</textarea>
                {{ render_suggestion_switcher('main_risks_txt', general_plan.main_risks_txt,
                specialized_plan.main_risks_txt) }}
            </div>
            <div class="form-group">
                <label for="main_contraindications_txt" class="ai-label d-flex align-items-center"><span
                        class="generation-status-icon" id="icon-main_contraindications_txt">
                        <div class="spinner-border spinner-border-sm text-secondary" role="status"></div>
                    </span>禁忌・特記事項</label>
                <textarea name="main_contraindications_txt" id="main_contraindications_txt" class="form-control"
                    readonly placeholder="AIが生成中です...">{{ general_plan.main_contraindications_txt }}</textarea>
                {{ render_suggestion_switcher('main_contraindications_txt', general_plan.main_contraindications_txt,
                specialized_plan.main_contraindications_txt) }}
            </div>
            <div class="form-group">
                <label for="adl_equipment_and_assistance_details_txt" class="ai-label d-flex align-items-center"><span
                        class="generation-status-icon" id="icon-adl_equipment_and_assistance_details_txt">
                        <div class="spinner-border spinner-border-sm text-secondary" role="status"></div>
                    </span>使用用具及び介助内容等</label>
                <textarea name="adl_equipment_and_assistance_details_txt" id="adl_equipment_and_assistance_details_txt"
                    class="form-control" readonly
                    placeholder="AIが生成中です...">{{ general_plan.adl_equipment_and_assistance_details_txt }}</textarea>
                {{ render_suggestion_switcher('adl_equipment_and_assistance_details_txt',
                general_plan.adl_equipment_and_assistance_details_txt,
                specialized_plan.adl_equipment_and_assistance_details_txt) }}
            </div>
            <div class="form-group">
                <label for="goals_1_month_txt" class="ai-label d-flex align-items-center"><span
                        class="generation-status-icon" id="icon-goals_1_month_txt">
                        <div class="spinner-border spinner-border-sm text-secondary" role="status"></div>
                    </span>目標（1ヶ月）</label>
                <textarea name="goals_1_month_txt" id="goals_1_month_txt" class="form-control" readonly
                    placeholder="AIが生成中です...">{{ general_plan.goals_1_month_txt }}</textarea>
                {{ render_suggestion_switcher('goals_1_month_txt', general_plan.goals_1_month_txt,
                specialized_plan.goals_1_month_txt) }}
            </div>
            <div class="form-group">
                <label for="goals_at_discharge_txt" class="ai-label d-flex align-items-center"><span
                        class="generation-status-icon" id="icon-goals_at_discharge_txt">
                        <div class="spinner-border spinner-border-sm text-secondary" role="status"></div>
                    </span>目標（終了時）</label>
                <textarea name="goals_at_discharge_txt" id="goals_at_discharge_txt" class="form-control" readonly
                    placeholder="AIが生成中です...">{{ general_plan.goals_at_discharge_txt }}</textarea>
                {{ render_suggestion_switcher('goals_at_discharge_txt', general_plan.goals_at_discharge_txt,
                specialized_plan.goals_at_discharge_txt) }}
            </div>
            <div class="form-group">
                <label for="policy_treatment_txt" class="ai-label d-flex align-items-center"><span
                        class="generation-status-icon" id="icon-policy_treatment_txt">
                        <div class="spinner-border spinner-border-sm text-secondary" role="status"></div>
                    </span>治療方針</label>
                <textarea name="policy_treatment_txt" id="policy_treatment_txt" class="form-control" readonly
                    placeholder="AIが生成中です...">{{ general_plan.policy_treatment_txt }}</textarea>
                {{ render_suggestion_switcher('policy_treatment_txt', general_plan.policy_treatment_txt,
                specialized_plan.policy_treatment_txt) }}
            </div>
            <div class="form-group">
                <label for="policy_content_txt" class="ai-label d-flex align-items-center"><span
                        class="generation-status-icon" id="icon-policy_content_txt">
                        <div class="spinner-border spinner-border-sm text-secondary" role="status"></div>
                    </span>治療内容</label>
                <textarea name="policy_content_txt" id="policy_content_txt" class="form-control"
                    style="min-height: 200px;" readonly
                    placeholder="AIが生成中です...">{{ general_plan.policy_content_txt }}</textarea>
                {{ render_suggestion_switcher('policy_content_txt', general_plan.policy_content_txt,
                specialized_plan.policy_content_txt) }}
            </div>

            <h3 class="section-title">心身機能・構造に関する特記事項</h3>
            <div class="form-group">
                <label for="func_pain_txt" class="ai-label d-flex align-items-center"><span
                        class="generation-status-icon" id="icon-func_pain_txt">
                        <div class="spinner-border spinner-border-sm text-secondary" role="status"></div>
                    </span>疼痛</label>
                <textarea name="func_pain_txt" id="func_pain_txt" class="form-control" readonly
                    placeholder="AIが生成中です...">{{ general_plan.func_pain_txt }}</textarea>
                {{ render_suggestion_switcher('func_pain_txt', general_plan.func_pain_txt,
                specialized_plan.func_pain_txt) }}
            </div>
            <div class="form-group">
                <label for="func_rom_limitation_txt" class="ai-label d-flex align-items-center"><span
                        class="generation-status-icon" id="icon-func_rom_limitation_txt">
                        <div class="spinner-border spinner-border-sm text-secondary" role="status"></div>
                    </span>関節可動域制限</label>
                <textarea name="func_rom_limitation_txt" id="func_rom_limitation_txt" class="form-control" readonly
                    placeholder="AIが生成中です...">{{ general_plan.func_rom_limitation_txt }}</textarea>
                {{ render_suggestion_switcher('func_rom_limitation_txt', general_plan.func_rom_limitation_txt,
                specialized_plan.func_rom_limitation_txt) }}
            </div>
            <div class="form-group">
                <label for="func_muscle_weakness_txt" class="ai-label d-flex align-items-center"><span
                        class="generation-status-icon" id="icon-func_muscle_weakness_txt">
                        <div class="spinner-border spinner-border-sm text-secondary" role="status"></div>
                    </span>筋力低下</label>
                <textarea name="func_muscle_weakness_txt" id="func_muscle_weakness_txt" class="form-control" readonly
                    placeholder="AIが生成中です...">{{ general_plan.func_muscle_weakness_txt }}</textarea>
                {{ render_suggestion_switcher('func_muscle_weakness_txt', general_plan.func_muscle_weakness_txt,
                specialized_plan.func_muscle_weakness_txt) }}
            </div>
            <div class="form-group">
                <label for="func_swallowing_disorder_txt" class="ai-label d-flex align-items-center"><span
                        class="generation-status-icon" id="icon-func_swallowing_disorder_txt">
                        <div class="spinner-border spinner-border-sm text-secondary" role="status"></div>
                    </span>摂食嚥下障害</label>
                <textarea name="func_swallowing_disorder_txt" id="func_swallowing_disorder_txt" class="form-control"
                    readonly placeholder="AIが生成中です...">{{ general_plan.func_swallowing_disorder_txt }}</textarea>
                {{ render_suggestion_switcher('func_swallowing_disorder_txt', general_plan.func_swallowing_disorder_txt,
                specialized_plan.func_swallowing_disorder_txt) }}
            </div>
            <div class="form-group">
                <label for="func_behavioral_psychiatric_disorder_txt" class="ai-label d-flex align-items-center"><span
                        class="generation-status-icon" id="icon-func_behavioral_psychiatric_disorder_txt">
                        <div class="spinner-border spinner-border-sm text-secondary" role="status"></div>
                    </span>精神行動障害</label>
                <textarea name="func_behavioral_psychiatric_disorder_txt" id="func_behavioral_psychiatric_disorder_txt"
                    class="form-control" readonly
                    placeholder="AIが生成中です...">{{ general_plan.func_behavioral_psychiatric_disorder_txt }}</textarea>
                {{ render_suggestion_switcher('func_behavioral_psychiatric_disorder_txt',
                general_plan.func_behavioral_psychiatric_disorder_txt,
                specialized_plan.func_behavioral_psychiatric_disorder_txt) }}
            </div>

            <div class="form-group">
                <label for="func_nutritional_disorder_txt" class="ai-label d-flex align-items-center"><span
                        class="generation-status-icon" id="icon-func_nutritional_disorder_txt">
                        <div class="spinner-border spinner-border-sm text-secondary" role="status"></div>
                    </span>栄養障害</label>
                <textarea name="func_nutritional_disorder_txt" id="func_nutritional_disorder_txt" class="form-control"
                    readonly placeholder="AIが生成中です...">{{ general_plan.func_nutritional_disorder_txt }}</textarea>
                {{ render_suggestion_switcher('func_nutritional_disorder_txt',
                general_plan.func_nutritional_disorder_txt, specialized_plan.func_nutritional_disorder_txt) }}
            </div>
            <div class="form-group">
                <label for="func_excretory_disorder_txt" class="ai-label d-flex align-items-center"><span
                        class="generation-status-icon" id="icon-func_excretory_disorder_txt">
                        <div class="spinner-border spinner-border-sm text-secondary" role="status"></div>
                    </span>排泄機能障害</label>
                <textarea name="func_excretory_disorder_txt" id="func_excretory_disorder_txt" class="form-control"
                    readonly placeholder="AIが生成中です...">{{ general_plan.func_excretory_disorder_txt }}</textarea>
                {{ render_suggestion_switcher('func_excretory_disorder_txt', general_plan.func_excretory_disorder_txt,
                specialized_plan.func_excretory_disorder_txt) }}
            </div>
            <div class="form-group">
                <label for="func_pressure_ulcer_txt" class="ai-label d-flex align-items-center"><span
                        class="generation-status-icon" id="icon-func_pressure_ulcer_txt">
                        <div class="spinner-border spinner-border-sm text-secondary" role="status"></div>
                    </span>褥瘡</label>
                <textarea name="func_pressure_ulcer_txt" id="func_pressure_ulcer_txt" class="form-control" readonly
                    placeholder="AIが生成中です...">{{ general_plan.func_pressure_ulcer_txt }}</textarea>
                {{ render_suggestion_switcher('func_pressure_ulcer_txt', general_plan.func_pressure_ulcer_txt,
                specialized_plan.func_pressure_ulcer_txt) }}
            </div>
            <div class="form-group">
                <label for="func_contracture_deformity_txt" class="ai-label d-flex align-items-center"><span
                        class="generation-status-icon" id="icon-func_contracture_deformity_txt">
                        <div class="spinner-border spinner-border-sm text-secondary" role="status"></div>
                    </span>拘縮・変形</label>
                <textarea name="func_contracture_deformity_txt" id="func_contracture_deformity_txt" class="form-control"
                    readonly placeholder="AIが生成中です...">{{ general_plan.func_contracture_deformity_txt }}</textarea>
                {{ render_suggestion_switcher('func_contracture_deformity_txt',
                general_plan.func_contracture_deformity_txt, specialized_plan.func_contracture_deformity_txt) }}
            </div>
            <div class="form-group">
                <label for="func_motor_muscle_tone_abnormality_txt" class="ai-label d-flex align-items-center"><span
                        class="generation-status-icon" id="icon-func_motor_muscle_tone_abnormality_txt">
                        <div class="spinner-border spinner-border-sm text-secondary" role="status"></div>
                    </span>筋緊張異常</label>
                <textarea name="func_motor_muscle_tone_abnormality_txt" id="func_motor_muscle_tone_abnormality_txt"
                    class="form-control" readonly
                    placeholder="AIが生成中です...">{{ general_plan.func_motor_muscle_tone_abnormality_txt }}</textarea>
                {{ render_suggestion_switcher('func_motor_muscle_tone_abnormality_txt',
                general_plan.func_motor_muscle_tone_abnormality_txt,
                specialized_plan.func_motor_muscle_tone_abnormality_txt) }}
            </div>
            <div class="form-group">
                <label for="func_disorientation_txt" class="ai-label d-flex align-items-center"><span
                        class="generation-status-icon" id="icon-func_disorientation_txt">
                        <div class="spinner-border spinner-border-sm text-secondary" role="status"></div>
                    </span>見当識障害</label>
                <textarea name="func_disorientation_txt" id="func_disorientation_txt" class="form-control" readonly
                    placeholder="AIが生成中です...">{{ general_plan.func_disorientation_txt }}</textarea>
                {{ render_suggestion_switcher('func_disorientation_txt', general_plan.func_disorientation_txt,
                specialized_plan.func_disorientation_txt) }}
            </div>
            <div class="form-group">
                <label for="func_memory_disorder_txt" class="ai-label d-flex align-items-center"><span
                        class="generation-status-icon" id="icon-func_memory_disorder_txt">
                        <div class="spinner-border spinner-border-sm text-secondary" role="status"></div>
                    </span>記憶障害</label>
                <textarea name="func_memory_disorder_txt" id="func_memory_disorder_txt" class="form-control" readonly
                    placeholder="AIが生成中です...">{{ general_plan.func_memory_disorder_txt }}</textarea>
                {{ render_suggestion_switcher('func_memory_disorder_txt', general_plan.func_memory_disorder_txt,
                specialized_plan.func_memory_disorder_txt) }}
            </div>


            <h2 class="section-title">【2枚目】目標詳細・具体的な対応方針</h2>
            <div class="form-group">
                <label for="goal_p_action_plan_txt" class="ai-label d-flex align-items-center"><span
                        class="generation-status-icon" id="icon-goal_p_action_plan_txt">
                        <div class="spinner-border spinner-border-sm text-secondary" role="status"></div>
                    </span>参加の具体的な対応方針</label>
                <textarea name="goal_p_action_plan_txt" id="goal_p_action_plan_txt" class="form-control" readonly
                    placeholder="AIが生成中です...">{{ general_plan.goal_p_action_plan_txt }}</textarea>
                {{ render_suggestion_switcher('goal_p_action_plan_txt', general_plan.goal_p_action_plan_txt,
                specialized_plan.goal_p_action_plan_txt) }}
            </div>
            <div class="form-group">
                <label for="goal_a_action_plan_txt" class="ai-label d-flex align-items-center"><span
                        class="generation-status-icon" id="icon-goal_a_action_plan_txt">
                        <div class="spinner-border spinner-border-sm text-secondary" role="status"></div>
                    </span>活動の具体的な対応方針</label>
                <textarea name="goal_a_action_plan_txt" id="goal_a_action_plan_txt" class="form-control" readonly
                    placeholder="AIが生成中です...">{{ general_plan.goal_a_action_plan_txt }}</textarea>
                {{ render_suggestion_switcher('goal_a_action_plan_txt', general_plan.goal_a_action_plan_txt,
                specialized_plan.goal_a_action_plan_txt) }}
            </div>

            <div class="form-group">
                <label for="goal_s_psychological_action_plan_txt" class="ai-label d-flex align-items-center"><span
                        class="generation-status-icon" id="icon-goal_s_psychological_action_plan_txt">
                        <div class="spinner-border spinner-border-sm text-secondary" role="status"></div>
                    </span>心理の具体的な対応方針</label>
                <textarea name="goal_s_psychological_action_plan_txt" id="goal_s_psychological_action_plan_txt"
                    class="form-control" readonly
                    placeholder="AIが生成中です...">{{ general_plan.goal_s_psychological_action_plan_txt }}</textarea>
                {{ render_suggestion_switcher('goal_s_psychological_action_plan_txt',
                general_plan.goal_s_psychological_action_plan_txt,
                specialized_plan.goal_s_psychological_action_plan_txt) }}
            </div>
            <div class="form-group">
                <label for="goal_s_env_action_plan_txt" class="ai-label d-flex align-items-center"><span
                        class="generation-status-icon" id="icon-goal_s_env_action_plan_txt">
                        <div class="spinner-border spinner-border-sm text-secondary" role="status"></div>
                    </span>環境の具体的な対応方針</label>
                <textarea name="goal_s_env_action_plan_txt" id="goal_s_env_action_plan_txt" class="form-control"
                    readonly placeholder="AIが生成中です...">{{ general_plan.goal_s_env_action_plan_txt }}</textarea>
                {{ render_suggestion_switcher('goal_s_env_action_plan_txt', general_plan.goal_s_env_action_plan_txt,
                specialized_plan.goal_s_env_action_plan_txt) }}
            </div>

            <div class="form-group">
                <label for="goal_s_3rd_party_action_plan_txt" class="ai-label d-flex align-items-center"><span
                        class="generation-status-icon" id="icon-goal_s_3rd_party_action_plan_txt">
                        <div class="spinner-border spinner-border-sm text-secondary" role="status"></div>
                    </span>第三者の不利に関する具体的な対応方針</label>
                <textarea name="goal_s_3rd_party_action_plan_txt" id="goal_s_3rd_party_action_plan_txt"
                    class="form-control" readonly
                    placeholder="AIが生成中です...">{{ general_plan.goal_s_3rd_party_action_plan_txt }}</textarea>
                {{ render_suggestion_switcher('goal_s_3rd_party_action_plan_txt',
                general_plan.goal_s_3rd_party_action_plan_txt, specialized_plan.goal_s_3rd_party_action_plan_txt) }}
            </div>

            <div class="form-group">
                <button type="submit" id="submit-button" class="submit-btn" disabled>AI生成完了までお待ちください...</button>
            </div>
        </form>
        <!-- <div id="rag-source-container" style="display: none; margin-top: 30px;">
            <h2 class="section-title">AI(特化モデル)が参考にした情報源</h2>
            <div id="rag-source-list" class="list-group">
            </div>
        </div> -->
        <div id="rag-source-container" style="display: none; margin-top: 15px;">
            <details>
                <summary>AI(特化モデル)が参考にした情報源</summary>
                <div id="rag-source-list" class="list-group" style="margin-top: 15px;">
                </div>
            </details>
        </div>

        <!-- 再生成モーダル -->
        <div class="modal fade" id="regenerateModal" tabindex="-1" aria-labelledby="regenerateModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="regenerateModalLabel">提案の再生成</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <!-- ▼▼▼ UI改善のため追加 ▼▼▼ -->
                        <div class="mb-3">
                            <label class="form-label"><strong>再生成対象</strong></label>
                            <p id="regenerate-item-name" class="form-control-plaintext ps-2 bg-light border rounded mb-0"></p>
                        </div>
                        <div class="mb-3">
                            <label class="form-label"><strong>現在の提案内容</strong></label>
                            <div id="regenerate-current-text-display" class="p-2 bg-light border rounded" style="white-space: pre-wrap; max-height: 150px; overflow-y: auto;"></div>
                        </div>
                        <!-- ▲▲▲ UI改善のため追加 ▲▲▲ -->
                        <p>現在の提案内容に対して、どのような修正を加えたいですか？<br>（例：もっと専門用語を減らして、箇条書きで簡潔に）</p>
                        <textarea id="regeneration-instruction" class="form-control no-style-change" rows="3" placeholder="指示を入力..."></textarea>
                        <input type="hidden" id="regenerate-item-key">
                        <input type="hidden" id="regenerate-model-type">
                        <input type="hidden" id="regenerate-current-text">
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                        <button type="button" id="execute-regeneration-btn" class="btn btn-primary">再生成を実行</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="fixed-buttons">

            <!-- 編集ボタン -->
            <div class="fixed-buttons">
                <button id="global-undo-button" class="submit-btn">←<br>元に戻す</button>
                <button id="global-redo-button" class="submit-btn">→<br>やり直す</button>
                <hr>
                <button id="reset-active-button" class="submit-btn">選択欄<br>リセット</button>
                <button id="reset-all-button" class="submit-btn">全入力欄<br>リセット</button>
            </div>
        </div>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
        <script>
            // グローバルスコープで変数を定義
            // app.pyから渡された項目名のマッピング
            const ITEM_KEY_TO_JAPANESE = {
                'main_risks_txt': '安静度・リスク',
                'main_contraindications_txt': '禁忌・特記事項',
                'adl_equipment_and_assistance_details_txt': '使用用具及び介助内容等',
                'goals_1_month_txt': '目標（1ヶ月）',
                'goals_at_discharge_txt': '目標（終了時）',
                'policy_treatment_txt': '治療方針',
                'policy_content_txt': '治療内容',
                'func_pain_txt': '疼痛',
                'func_rom_limitation_txt': '関節可動域制限',
                'func_muscle_weakness_txt': '筋力低下',
                'func_swallowing_disorder_txt': '摂食嚥下障害',
                'func_behavioral_psychiatric_disorder_txt': '精神行動障害',
                'func_nutritional_disorder_txt': '栄養障害',
                'func_excretory_disorder_txt': '排泄機能障害',
                'func_pressure_ulcer_txt': '褥瘡',
                'func_contracture_deformity_txt': '拘縮・変形',
                'func_motor_muscle_tone_abnormality_txt': '筋緊張異常',
                'func_disorientation_txt': '見当識障害',
                'func_memory_disorder_txt': '記憶障害',
                'goal_p_action_plan_txt': '参加の具体的な対応方針',
                'goal_a_action_plan_txt': '活動の具体的な対応方針',
                'goal_s_psychological_action_plan_txt': '心理の具体的な対応方針',
                'goal_s_env_action_plan_txt': '環境の具体的な対応方針',
                'goal_s_3rd_party_action_plan_txt': '第三者の不利に関する具体的な対応方針'
            };
            let regenerationEventSource = null;
            let activeRegenerateTextDiv = null;
            let regeneratedItems = new Set(); // 【追加】再生成履歴を記録するSet


            document.addEventListener('DOMContentLoaded', function () {
                const suggestionContainers = document.querySelectorAll('.suggestion-container');
                const modelNames = ["通常モデル", "特化モデル(RAG)"];

                suggestionContainers.forEach(container => {
                    const switchBtns = container.querySelectorAll('.suggestion-switch-btn');
                    const modelNameEl = container.querySelector('.model-name');
                    const contents = container.querySelectorAll('.suggestion-content');
                    let currentIndex = 0;

                    switchBtns.forEach(btn => {
                        btn.addEventListener('click', () => {
                            const direction = btn.dataset.direction;
                            contents[currentIndex].classList.remove('active');

                            if (direction === 'next') {
                                currentIndex = (currentIndex + 1) % contents.length;
                            } else {
                                currentIndex = (currentIndex - 1 + contents.length) % contents.length;
                            }

                            contents[currentIndex].classList.add('active');
                            modelNameEl.textContent = modelNames[currentIndex];
                        });
                    });

                    // 「この提案を適用」ボタンの処理
                    container.querySelectorAll('.apply-suggestion-btn').forEach(applyBtn => {
                        applyBtn.addEventListener('click', function () {
                            const targetId = container.dataset.targetId;
                            const targetTextarea = document.getElementById(targetId);
                            const activeContent = container.querySelector('.suggestion-content.active');
                            const sourceTextDiv = activeContent.querySelector('.suggestion-text');

                            if (targetTextarea && sourceTextDiv) {
                        const modelType = activeContent.dataset.modelType;
                        appliedSuggestions[targetId] = modelType;

                                targetTextarea.value = sourceTextDiv.textContent.trim();
                                targetTextarea.dispatchEvent(new Event('input', { bubbles: true }));
                            }
                        });
                    });
                });

                // いいね機能のロジック
                document.querySelectorAll('.like-btn').forEach(btn => {
                    btn.addEventListener('click', function () {
                        const suggestionContainer = this.closest('.suggestion-container');
                        const targetId = suggestionContainer.dataset.targetId;
                        const suggestionContent = this.closest('.suggestion-content');
                        const modelType = suggestionContent.dataset.modelType;
                        const patientId = document.querySelector('input[name="patient_id"]').value;
                        const isCurrentlyLiked = this.classList.contains('liked');

                        this.classList.toggle('liked', !isCurrentlyLiked);

                        const icon = this.querySelector('i');
                        const isLiked = this.classList.contains('liked');
                        icon.classList.toggle('bi-hand-thumbs-up-fill', isLiked);
                        icon.classList.toggle('bi-hand-thumbs-up', !isLiked);

                // 【追加】いいね時に、その提案内容を自動的に隠しフィールドに反映する
                if (isLiked) {
                    const suggestionText = suggestionContent.querySelector('.suggestion-text').textContent.trim();
                    const hiddenInput = document.getElementById(`hidden-suggestion-${modelType}-${targetId}`);
                    if (hiddenInput) {
                        hiddenInput.value = suggestionText;
                    }
                }

                // いいねの状態を hidden input に反映する
                const likedStatusInput = document.getElementById(`liked-status-${targetId}-${modelType}`);
                if (likedStatusInput) {
                    likedStatusInput.value = isLiked ? 'true' : 'false';
                }

                        fetch("{{ url_for('like_suggestion') }}", {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                patient_id: patientId,
                                item_key: targetId,
                                liked_model: isLiked ? modelType : null,
                                model_to_delete: isCurrentlyLiked ? modelType : null
                            })
                        })
                            .then(response => response.json())
                            .then(data => console.log('Like update:', data.message))
                            .catch(error => {
                                console.error('Error sending like:', error);
                                alert('評価の送信に失敗しました。');
                            });
                    });
                });


                // --- 再生成機能のロジック ---
                const regenerateModal = new bootstrap.Modal(document.getElementById('regenerateModal'));
                const instructionTextarea = document.getElementById('regeneration-instruction');
                const hiddenItemKey = document.getElementById('regenerate-item-key');
                const hiddenModelType = document.getElementById('regenerate-model-type');
                const hiddenCurrentText = document.getElementById('regenerate-current-text');
                const itemNameDisplay = document.getElementById('regenerate-item-name');
                const currentTextDisplay = document.getElementById('regenerate-current-text-display');

                document.querySelectorAll('.regenerate-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const suggestionContent = this.closest('.suggestion-content');
                        const suggestionContainer = this.closest('.suggestion-container');
                        const itemKey = suggestionContainer.dataset.targetId;
                        const modelType = suggestionContent.dataset.modelType;
                        const currentText = suggestionContent.querySelector('.suggestion-text').textContent.trim();

                        hiddenItemKey.value = itemKey;
                        hiddenModelType.value = modelType;
                        hiddenCurrentText.value = currentText;
                        // モーダル内の表示を更新
                        const japaneseName = ITEM_KEY_TO_JAPANESE[itemKey] || itemKey;
                        itemNameDisplay.textContent = `${japaneseName} (${modelType === 'general' ? '通常モデル' : '特化モデル'})`;
                        currentTextDisplay.textContent = currentText;
                        instructionTextarea.value = ''; // モーダルを開くたびにクリア
                    });
                });

                document.getElementById('execute-regeneration-btn').addEventListener('click', function() {
                    const itemKey = hiddenItemKey.value;
                    const modelType = hiddenModelType.value;
                    const currentText = hiddenCurrentText.value;
                    const instruction = instructionTextarea.value;
                    const patientId = document.querySelector('input[name="patient_id"]').value;
                    const therapistNotes = document.querySelector('input[name="therapist_notes"]').value; // 【追加】所見を取得

                    if (!instruction.trim()) {
                        alert('指示を入力してください。');
                        return;
                    }

                    // 【追加】再生成時に「いいね」を取り消すロジック
                    const suggestionContent = document.getElementById(`suggestion-${modelType}-${itemKey}`).closest('.suggestion-content');
                    const likeBtn = suggestionContent.querySelector('.like-btn');

                    if (likeBtn && likeBtn.classList.contains('liked')) {
                        console.log(`Regeneration triggered for a liked item (${itemKey} - ${modelType}). Removing the like.`);

                        // UI上のいいね状態を解除
                        likeBtn.classList.remove('liked');
                        const icon = likeBtn.querySelector('i');
                        icon.classList.remove('bi-hand-thumbs-up-fill');
                        icon.classList.add('bi-hand-thumbs-up');

                        // DBからいいね情報を削除するAPIを呼び出す
                        fetch("{{ url_for('like_suggestion') }}", {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                patient_id: patientId,
                                item_key: itemKey,
                                model_to_delete: modelType // 削除対象のモデルタイプを指定
                            })
                        }).catch(error => console.error('Error removing like on regeneration:', error));
                    }

                    // 【追加】再生成が実行されたことを記録
                    regeneratedItems.add(`${itemKey}-${modelType}`);

                    regenerateModal.hide();

                    // 対象のテキスト表示エリアを取得
                    activeRegenerateTextDiv = document.getElementById(`suggestion-${modelType}-${itemKey}`);
                    if (!activeRegenerateTextDiv) return;

                    // ローディング表示
                    activeRegenerateTextDiv.innerHTML = '<div class="spinner-border spinner-border-sm" role="status"></div> 再生成中...';

                    // 既存のEventSourceがあれば閉じる
                    if (regenerationEventSource) {
                        regenerationEventSource.close();
                        regenerationEventSource = null;
                    }

                    // fetch APIを使用してストリーミングリクエストを送信
                    fetch('/api/regenerate', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            patient_id: patientId,
                            item_key: itemKey,
                            current_text: currentText,
                            instruction: instruction,
                            model_type: modelType,
                            therapist_notes: therapistNotes
                        })
                    }).then(response => {
                        if (!response.ok) {
                            // HTTPステータスが200番台でない場合
                            return response.text().then(text => {
                                throw new Error(text || `サーバーエラー: ${response.status}`);
                            });
                        }
                        const reader = response.body.getReader();
                        const decoder = new TextDecoder();
                        let regeneratedText = '';
                        let buffer = '';

                        function processStream({ done, value }) {
                            if (done) {
                                // 再生成完了時に初期値を更新
                                const trimmedText = regeneratedText.trim();
                                if (modelType === 'general') {
                                    generalSuggestions[itemKey].push(trimmedText);
                                } else {
                                    specializedSuggestions[itemKey].push(trimmedText);
                                }
                                console.log('Regeneration finished.');
                                return;
                            }

                            buffer += decoder.decode(value, { stream: true });
                            const lines = buffer.split('\n\n');
                            buffer = lines.pop(); // 最後の不完全なメッセージをバッファに残す

                            lines.forEach(line => {
                                if (line.startsWith('event: update')) {
                                    const dataStr = line.substring(line.indexOf('data: ') + 6);
                                    try {
                                        const data = JSON.parse(dataStr);
                                        regeneratedText += data.chunk;
                                        //【修正】Markdownではなくプレーンテキストとして表示
                                        activeRegenerateTextDiv.innerText = regeneratedText;
                                    } catch (e) {
                                        console.error('Error parsing stream data:', e);
                                    }
                                } else if (line.startsWith('event: finished')) {
                                    // ストリーム終了
                                } else if (line.startsWith('event: error')) {
                                    const dataStr = line.substring(line.indexOf('data: ') + 6);
                                    const errorData = JSON.parse(dataStr);
                                    throw new Error(errorData.error || '不明なストリームエラー');
                                }
                            });

                            return reader.read().then(processStream);
                        }
                        return reader.read().then(processStream);
                    }).catch(error => {
                        console.error('Regeneration fetch error:', error);
                        activeRegenerateTextDiv.textContent = `エラー: ${error.message}`;
                    });
                });

                // --- Undo/Redoと編集状態の管理 ---
                const historyManager = {};
                let activeInputId = null;
                const generalSuggestions = {};
                const specializedSuggestions = {}; 
                const appliedSuggestions = {};

                // 【追加】フォーム送信時に再生成履歴をhidden inputに設定
                document.getElementById('confirm-form').addEventListener('submit', function() {
                    const historyInput = document.getElementById('regeneration-history-input');
                    historyInput.value = JSON.stringify(Array.from(regeneratedItems));
                });



                const form = document.getElementById('confirm-form');
                const submitButton = document.getElementById('submit-button');

                function updateElementStyle(element) {
                    if (!element || !element.id) return;
                    const generalHistory = generalSuggestions[element.id] || [];
                    const specializedHistory = specializedSuggestions[element.id] || [];
                    const currentValue = element.value;
                    if (generalHistory.includes(currentValue) || specializedHistory.includes(currentValue)) {

                        element.classList.remove('is-edited');
                        element.classList.add('is-default');
                    } else {
                        element.classList.remove('is-default');
                        element.classList.add('is-edited');
                    }
                }

                function initializeDefaultValues() {
                    document.querySelectorAll('textarea.form-control').forEach(element => {
                        if (element.id) {
                            if (!generalSuggestions[element.id]) {
                                generalSuggestions[element.id] = [element.value];
                            }
                            const specializedDiv = document.getElementById(`suggestion-specialized-${element.id}`);
                            if (specializedDiv && !specializedSuggestions[element.id]) {
                                specializedSuggestions[element.id] = [specializedDiv.textContent.trim()];

                            }
                            updateElementStyle(element);
                        }
                    });
                }

                initializeDefaultValues();

                document.addEventListener('focusin', (event) => {
                    if (event.target.tagName === 'TEXTAREA' && event.target.classList.contains('form-control')) {
                        activeInputId = event.target.id;
                        if (activeInputId && !historyManager[activeInputId]) {
                            historyManager[activeInputId] = { history: [event.target.value], index: 0, debounceTimer: null };
                        }
                    }
                });

                document.addEventListener('input', (event) => {
                    if (event.target.tagName === 'TEXTAREA' && event.target.classList.contains('form-control') && !event.target.classList.contains('no-style-change')) {

                        updateElementStyle(event.target);
                        if (event.target.id === activeInputId) {
                            const data = historyManager[activeInputId];
                            if (!data) return;
                            clearTimeout(data.debounceTimer);
                            data.debounceTimer = setTimeout(() => {
                                if (event.target.value !== data.history[data.index]) {
                                    data.history.splice(data.index + 1);
                                    data.history.push(event.target.value);
                                    data.index = data.history.length - 1;
                                }
                            }, 300);
                        }
                    }
                });


                // --- ボタンの処理 ---
                document.getElementById('global-undo-button').addEventListener('click', () => {
                    if (activeInputId && historyManager[activeInputId] && historyManager[activeInputId].index > 0) {
                        const data = historyManager[activeInputId];
                        data.index--;
                        const element = document.getElementById(activeInputId);
                        element.value = data.history[data.index];
                        updateElementStyle(element);
                    }
                });

                document.getElementById('global-redo-button').addEventListener('click', () => {
                    if (activeInputId && historyManager[activeInputId] && historyManager[activeInputId].index < historyManager[activeInputId].history.length - 1) {
                        const data = historyManager[activeInputId];
                        data.index++;
                        const element = document.getElementById(activeInputId);
                        element.value = data.history[data.index];
                        updateElementStyle(element);
                    }
                });

                document.getElementById('reset-active-button').addEventListener('click', () => {
                    if (!activeInputId) {
                        alert('リセットしたい入力欄を先にクリックしてください。');
                        return;
                    }
                    const element = document.getElementById(activeInputId);
                    const suggestionContainer = document.querySelector(`.suggestion-container[data-target-id="${activeInputId}"]`);
                    if (element && suggestionContainer) {
                        const activeSuggestion = suggestionContainer.querySelector('.suggestion-content.active .suggestion-text');
                        if (activeSuggestion) {
                            const resetValue = activeSuggestion.textContent.trim();
                            element.value = resetValue;
                            element.dispatchEvent(new Event('input', { bubbles: true })); // スタイルと履歴を更新

                        }
                    }
                });

                document.getElementById('reset-all-button').addEventListener('click', () => {
                    if (!confirm('全ての入力内容を初期状態に戻します。よろしいですか？')) return;
                    document.querySelectorAll('textarea.form-control').forEach(element => {
                        const id = element.id;
                        if (!id) return;
                        const suggestionContainer = document.querySelector(`.suggestion-container[data-target-id="${id}"]`);
                        if (suggestionContainer) {
                            const activeSuggestion = suggestionContainer.querySelector('.suggestion-content.active .suggestion-text');
                            if (activeSuggestion) {
                                const resetValue = activeSuggestion.textContent.trim();
                                element.value = resetValue;
                                element.dispatchEvent(new Event('input', { bubbles: true })); // スタイルと履歴を更新
                            }
                        }

                    });
                });

                // AIによるストリーミング生成処理
                {% if is_generating %}
                const generationHeaderStatus = document.getElementById('generation-header-status');
                const generationFinishedText = document.getElementById('generation-finished-text');
                let isGeneralFinished = false;
                let isRagFinished = false;

                function updateAllHiddenInputs() {
                    Object.keys(generalSuggestions).forEach(key => {
                        const hiddenGeneral = document.getElementById(`hidden-suggestion-general-${key}`);
                        if (hiddenGeneral && generalSuggestions[key] && generalSuggestions[key].length > 0) {
                            hiddenGeneral.value = generalSuggestions[key][generalSuggestions[key].length - 1];
                        }
                    });
                    Object.keys(specializedSuggestions).forEach(key => {
                        const hiddenSpecialized = document.getElementById(`hidden-suggestion-specialized-${key}`);
                        if (hiddenSpecialized && specializedSuggestions[key] && specializedSuggestions[key].length > 0) {
                            hiddenSpecialized.value = specializedSuggestions[key][specializedSuggestions[key].length - 1];
                        }
                    });
                }


                function checkAllFinished() {
                    if (isGeneralFinished && isRagFinished) {
                        updateAllHiddenInputs(); // ここで一括更新
                        generationHeaderStatus.classList.remove('alert-info');
                        generationHeaderStatus.classList.add('alert-success');
                        generationHeaderStatus.innerHTML = '<div class="d-flex align-items-center"><i class="bi bi-check-circle-fill me-2"></i><strong>AIによる生成がすべて完了しました。</strong></div>';
                        generationFinishedText.style.display = 'block';
                        submitButton.textContent = 'この内容で確定して保存';
                        initializeDefaultValues();
                    }
                }

                const ragPipelineName = "hybrid_search_experiment";
                const patientId = "{{ patient_data.patient_id }}";
                const therapistNotes = "{{ therapist_notes|urlencode }}";
                const queryParams = `?patient_id=${patientId}&therapist_notes=${therapistNotes}`;


                // --- 1. Gemini単体（汎用モデル）のストリーム接続 ---
                const generalApiUrl = "{{ url_for('generate_general_stream') }}" + queryParams;
                const generalEventSource = new EventSource(generalApiUrl);

                generalEventSource.addEventListener('update', function (event) {
                    const data = JSON.parse(event.data);
                    const { key, value } = data;
                    const mainTextarea = document.getElementById(key);
                    const suggestionDiv = document.getElementById(`suggestion-general-${key}`);
                    const iconEl = document.getElementById(`icon-${key}`);

                    if (mainTextarea) {
                        mainTextarea.value = value;
                        mainTextarea.readOnly = false;
                        mainTextarea.placeholder = '';
                        if (!generalSuggestions[key]) generalSuggestions[key] = [];
                        if (!generalSuggestions[key].includes(value)) generalSuggestions[key].push(value);

                        updateElementStyle(mainTextarea);
                    }
                    if (suggestionDiv) {
                        suggestionDiv.textContent = value;
                    }


                    if (iconEl) {
                        iconEl.innerHTML = '<i class="bi bi-check-circle-fill text-success"></i>';
                    }
                });

                generalEventSource.addEventListener('general_finished', function (event) {
                    console.log("General model generation finished.");
                    isGeneralFinished = true;
                    submitButton.disabled = false;
                    submitButton.textContent = 'この内容で確定して保存 (RAG専門項目 生成中...)';
                    checkAllFinished();
                    generalEventSource.close();
                });

                generalEventSource.addEventListener('error', function (event) {
                    let errorMessage = "汎用モデルの生成中にエラーが発生しました。";
                    if (event.data) {
                        try {
                            const data = JSON.parse(event.data);
                            if (data.error) errorMessage = data.error;
                        } catch (e) { /* no-op */ }
                    }
                    generationHeaderStatus.innerHTML = `<div class="d-flex align-items-center"><i class="bi bi-exclamation-triangle-fill me-2"></i><strong>エラー:</strong> ${errorMessage}</div>`;
                    generationHeaderStatus.classList.remove('alert-info');
                    generationHeaderStatus.classList.add('alert-danger');
                    isGeneralFinished = true;
                    checkAllFinished();
                    generalEventSource.close();
                });

                // --- 2. RAG（特化モデル）のストリーム接続 ---
                const ragApiUrl = `/api/generate/rag/${ragPipelineName}` + queryParams;
                const ragEventSource = new EventSource(ragApiUrl);

                ragEventSource.addEventListener('update', function (event) {
                    const data = JSON.parse(event.data);
                    const { key, value } = data;
                    const suggestionDiv = document.getElementById(`suggestion-specialized-${key}`);
                    const iconEl = document.getElementById(`icon-${key}`);

                    if (suggestionDiv) {
                        suggestionDiv.textContent = value;
                        const trimmedValue = value.trim();
                        if (!specializedSuggestions[key]) specializedSuggestions[key] = [];
                        if (!specializedSuggestions[key].includes(trimmedValue)) specializedSuggestions[key].push(trimmedValue);

                    }
                    if (iconEl) {
                        iconEl.innerHTML = '<i class="bi bi-patch-check-fill text-primary"></i>';
                    }


                });

                const ragSourceContainer = document.getElementById('rag-source-container');
                const ragSourceList = document.getElementById('rag-source-list');

                ragEventSource.addEventListener('context_update', function (event) {
                    const contexts = JSON.parse(event.data);
                    ragSourceList.innerHTML = '';
                    if (contexts && contexts.length > 0) {
                        contexts.forEach((ctx, index) => {
                            const listItem = document.createElement('div');
                            listItem.className = 'list-group-item list-group-item-action flex-column align-items-start mb-2';
                            const originalContent = (ctx.content || '');
                            let contentHtml = '';
                            const mermaidRegex = /```mermaid([\s\S]*?)```/;
                            const match = originalContent.match(mermaidRegex);
                            let isMermaid = false;
                            let mermaidCode = '';

                            if (match && match[1]) {
                                isMermaid = true;
                                mermaidCode = match[1].trim();
                            } else if (!originalContent.includes('```') && (originalContent.trim().startsWith('graph') || originalContent.trim().startsWith('flowchart'))) {
                                isMermaid = true;
                                mermaidCode = originalContent.trim();
                            }

                            if (isMermaid) {
                                contentHtml = `<div class="mermaid">${mermaidCode}</div>`;
                            } else {
                                contentHtml = `<div class="markdown-body mt-2">${marked.parse(originalContent)}</div>`;
                            }

                            const sectionPath = [ctx.section, ctx.subsection, ctx.subsubsection].filter(s => s && s !== 'N/A').join(' > ');
                            listItem.innerHTML = `
                        <div class="d-flex w-100 justify-content-between">
                            <h5 class="mb-1">出典[${ctx.id}]: ${ctx.source || 'N/A'}</h5>
                            <small class="text-muted">${ctx.disease || ''}</small>
                        </div>
                        ${contentHtml}
                        <small class="text-muted">セクション: ${sectionPath || 'N/A'}</small>
                    `;
                            ragSourceList.appendChild(listItem);
                        });
                        ragSourceContainer.style.display = 'block';
                        setTimeout(() => {
                            try {
                                if (window.mermaid) {
                                    mermaid.run({ nodes: document.querySelectorAll('.mermaid') });
                                }
                            } catch (e) { console.error("Mermaid rendering error:", e); }
                        }, 100);
                    }
                });

                ragEventSource.addEventListener('finished', function (event) {
                    console.log("RAG model generation finished.");
                    isRagFinished = true;
                    checkAllFinished();
                    ragEventSource.close();
                });

                ragEventSource.addEventListener('error', function (event) {
                    let errorMessage = "RAGモデルの生成中にエラーが発生しました。";
                    if (event.data) {
                        try {
                            const data = JSON.parse(event.data);
                            if (data.error) errorMessage = data.error;
                        } catch (e) { /* no-op */ }
                    }
                    console.error("RAG Stream Error:", errorMessage);
                    document.querySelectorAll('.suggestion-container').forEach(container => {
                        const specializedDiv = container.querySelector('.suggestion-content[data-model-type="specialized"] .suggestion-text');
                        if (specializedDiv && (specializedDiv.textContent === '生成中...' || specializedDiv.textContent === '')) {
                            specializedDiv.textContent = `エラー: ${errorMessage}`;
                            specializedDiv.style.color = 'red';
                        }
                    });
                    isRagFinished = true;
                    checkAllFinished();
                    ragEventSource.close();
                });
                {% endif %}
            });

        </script>
</body>

</html>